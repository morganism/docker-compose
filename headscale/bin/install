#!/bin/bash
: <<DOCXX
Add description
Author: morgan@morganism.dev
Date: Mon 29 Sep 2025 03:06:40 BST
DOCXX

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
NC='\033[0m' # No Color

DOCKER_DESKTOP_APP='/Applications/Docker.app/Contents/MacOS/Docker Desktop.app/Contents/MacOS/Docker Desktop'
HEADSCALE_BASE=${1:-$HOME}
HEADSCALE_CONFIG="${HEADSCALE_BASE}/headscale/config"
HEADSCALE_DATA="${HEADSCALE_BASE}/headscale/data"
HEADSCALE_CONFIG_YAML="${HEADSCALE_CONFIG}/config.yaml"

echo -e "${RED}Red ${GREEN}Green ${YELLOW}Yellow ${BLUE}Blue ${NC}"

if [[ $(command -v "$DOCKER_DESKTOP_APP" 2>/dev/null) ]]; then
  echo -e "${GREEN}Docker Desktop is installed.${NC}"
else
  echo -e "${BLUE}Installing Docker Desktop ...${NC}"
  brew install docker-desktop 2>&1 | grep '%'
  echo -e "${GREEN}Docker Desktop is installed.${NC}"
fi


echo -e "${BLUE}Creating/Ensuring Headscale config dirs in ${HEADSCALE_BASE} ...${NC}"
mkdir -p "${HEADSCALE_CONFIG}" "${HEADSCALE_DATA}"


cat > "$HEADSCALE_CONFIG_YAML" <<EOF
server_url: http://127.0.0.1:8080
listen_addr: 0.0.0.0:8080

private_key_path: /var/lib/headscale/private.key
derp:
  server:
    enabled: false
  urls:
    - https://controlplane.tailscale.com/derpmap/default
  auto_update_enabled: true

database:
  type: sqlite3
  sqlite:
    path: /var/lib/headscale/db.sqlite
EOF

  

: <<DOCUMENTATION
4. Run the Container

Now run Headscale with volume mounts for config and data:

docker run -d \
  --name headscale \
  -v ~/headscale/config:/etc/headscale \
  -v ~/headscale/data:/var/lib/headscale \
  -p 8080:8080 \
  headscale/headscale:latest \
  headscale serve


Config mount: /etc/headscale

Data mount: /var/lib/headscale

Port mapping: maps port 8080 inside container → 8080 on host

5. Verify Logs

Check if the server is running:

docker logs -f headscale

6. Create a Namespace (example)

You’ll likely want to create a namespace for clients:

docker exec -it headscale headscale namespaces create mynet

7. Add a Machine

Generate a pre-auth key:

docker exec -it headscale headscale preauthkeys create --reusable --namespace mynet


Use this key when joining Tailscale clients with:

tailscale up --login-server http://<your-mac-ip>:8080 --authkey <key>


⚠️ Note on Networking on macOS:
Docker Desktop uses a VM, so containers don’t run on the same network as your host.
To reach Headscale from other devices, you’ll need to:

Use your Mac’s IP (not 127.0.0.1) as server_url.

Ensure port 8080 is exposed in Docker Desktop.
DOCUMENTATION
